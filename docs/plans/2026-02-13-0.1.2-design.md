# clawpilot 0.1.2 Design

## Objective

Deliver a reliable and practical 0.1.2 release for `clawpilot` that improves install UX and config safety while preserving the lightweight `npx` workflow.

## Decisions Confirmed

- Execution mode: continuous delivery for full 0.1.2 scope.
- Installer interaction model: mixed mode.
- `--yes` behavior: hard fail if required data is missing.
- Priority order:
  1. Config reliability
  2. Install UX
  3. Productivity template quality
  4. Documentation

## Architecture

### 1. CLI Layer (`bin/cli.js`)

- Parse command arguments and normalize options.
- Support new flags:
  - `--yes`
  - `--timezone`
  - existing schedule options (`--morning`, `--midday`, `--evening`)
- Enforce validation rules:
  - Invalid schedule/timezone format -> fail with clear error.
  - Missing required values under `--yes` -> fail with exit code 1.
- Produce concise post-install summary and next-step commands.

### 2. Install Orchestration (`src/install.js`)

- Keep orchestration responsibilities only:
  - copy skill files
  - apply config updates
  - inject workspace files
  - return structured install result
- Delegate merge and workspace mutation to dedicated modules.

### 3. Config Module (`src/config.js`)

- Deep-merge behavior must preserve user custom fields.
- Managed fields:
  - `skills.entries.clawpilot-productivity.enabled`
  - `skills.entries.clawpilot-productivity.mode`
  - `skills.entries.clawpilot-productivity.schedule`
  - `skills.entries.clawpilot-productivity.timezone`
- Ensure `skills.load.extraDirs` is deduplicated.

### 4. Workspace Module (`src/workspace.js`)

- Marker-based injection for `workspace/SOUL.md`:
  - replace clawpilot section if present
  - keep non-clawpilot content untouched
- Write `workspace/IDENTITY.md` deterministically from template.
- Keep repeated installs idempotent.

## Data Flow

1. User runs `clawpilot install ...options`.
2. CLI parses and validates options.
3. Installer resolves defaults (schedule/timezone) or collects missing values in mixed mode.
4. With `--yes`, unresolved required values immediately fail.
5. Installer writes skill files and updates config/workspace.
6. CLI prints summary including skill path, config path, and next command examples.

## Error Handling

- Invalid option values return explicit actionable messages.
- `--yes` mode never prompts; it exits when data is incomplete.
- Existing installation without `--force` fails safely.
- Config parse failure falls back to empty config object, then rewrites valid JSON.

## Testing Strategy

### Unit Tests

- Config merge preserves pre-existing unknown fields.
- `skills.load.extraDirs` remains unique after repeated installs.
- Timezone and schedule options are parsed and persisted correctly.
- Marker injection stays single-instance after repeated install/force runs.

### CLI/Behavior Tests

- `--yes` with unresolved required input exits non-zero.
- Happy path install succeeds with explicit options.
- Reinstall with mixed options keeps idempotent state.

### Smoke Tests

- `node bin/cli.js install --home <temp>`
- `node bin/cli.js install --home <temp> --force --yes`
- `npm pack --dry-run`

## Scope Boundaries

In scope:
- install UX upgrades
- config reliability hardening
- productivity prompt template improvements
- troubleshooting docs

Out of scope:
- Telegram/Discord runtime integration
- external API calls
- background schedulers

## Release Readiness

0.1.2 is release-ready when:
- `npm test` passes
- smoke tests pass
- README and troubleshooting are updated
- package dry-run output is correct
